---
- name: Деплой Marzban (Logic - Install -> Keys -> Config)
  hosts: all
  become: yes
  vars:
    # Переменные прилетают из Makefile, но для тестов можно раскомментировать:
    # domain: "example.com"
    # email: "admin@example.com"

  tasks:
    # --- ЭТАП 1: ПОДГОТОВКА ---
    - name: 1. Установка системных утилит
      apt:
        name: [curl, socat, git, nginx, python3-pip, psmisc]
        update_cache: yes
        state: present

    - name: 2. Установка Certbot
      apt:
        name: certbot
        state: present

    - name: 3. Получение SSL сертификата
      shell: |
        systemctl stop nginx || true
        certbot certonly --standalone -d {{ domain }} --email {{ email }} --agree-tos --non-interactive
      args:
        creates: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
      register: certbot_result
      until: certbot_result.rc == 0
      retries: 3
      delay: 5

    # --- ЭТАП 2: УСТАНОВКА MARZBAN ---
    - name: 4. Установка Marzban
      script: ../marzban_fixed.sh install

    # --- ЭТАП 3: ГЕНЕРАЦИЯ КЛЮЧЕЙ НА ЖИВОЙ СИСТЕМЕ ---
    - name: 5. Генерация ключей Xray внутри контейнера
      shell: docker exec marzban-marzban-1 xray x25519
      register: xray_keys_raw

    - name: 6. Парсинг ключей в переменные
      set_fact:
        xray_private_key: "{{ xray_keys_raw.stdout | regex_search('Private key: (.*)', '\\1') | first | trim }}"
        xray_public_key: "{{ xray_keys_raw.stdout | regex_search('Public key: (.*)', '\\1') | first | trim }}"
        # Генерируем Short ID силами Ansible
        xray_short_id: "{{ lookup('password', '/dev/null chars=hex length=16') }}"

    - name: 7. Вывод ключей (Сохрани их!)
      debug:
        msg:
          - "Private Key: {{ xray_private_key }}"
          - "Public Key:  {{ xray_public_key }}"
          - "Short ID:    {{ xray_short_id }}"

    # --- ЭТАП 4: ПРИМЕНЕНИЕ КОНФИГУРАЦИИ ---
    - name: 8. Заливаем правильный конфиг Xray
      template:
        src: xray_config.json.j2
        dest: /var/lib/marzban/xray_config.json

    - name: 9. Настройка Nginx
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/sites-available/default

    - name: 10. Включение конфига Nginx
      file:
        src: /etc/nginx/sites-available/default
        dest: /etc/nginx/sites-enabled/default
        state: link

    # --- ЭТАП 5: ДОПОЛНИТЕЛЬНЫЕ СЕРВИСЫ ---
    - name: 11. Запуск Grafana
      docker_container:
        name: grafana
        image: grafana/grafana:latest
        ports:
          - "3000:3000"
        restart_policy: always
        env:
          GF_SERVER_ROOT_URL: "https://{{ domain }}/grafana/"
          GF_SERVER_SERVE_FROM_SUB_PATH: "true"

    # --- ЭТАП 6: ФИНАЛ ---
    - name: 12. Рестарт (Применяем всё)
      shell: |

        fuser -k 443/tcp || true
        marzban restart
      async: 60
      poll: 0

    - name: 13. Перезапуск Nginx
      systemd:
        name: nginx
        state: restarted
        enabled: yes

    - name: 14. Инструкция
      debug:
        msg: "Готово! Теперь зайди на сервер и выполни: marzban cli admin create --sudo"
